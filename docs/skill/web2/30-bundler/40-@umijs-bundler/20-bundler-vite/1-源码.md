# @umijs/bundler-vite

## ä¸€ã€é¡¹ç›®ä¿¡æ¯

1. **é¡¹ç›®å®šä½**
- è¿™æ˜¯ UmiJS æ¡†æ¶çš„ä¸€ä¸ªå­åŒ…,æä¾›åŸºäº Vite çš„æ„å»ºèƒ½åŠ›
- ç‰ˆæœ¬å·ä¸º 4.4.6
- éµå¾ª MIT å¼€æºåè®®
1. **ä¸»è¦ä¾èµ–**
- [`vite`](https://vitejs.dev/) v4.5.2 ä½œä¸ºæ ¸å¿ƒæ„å»ºå·¥å…·
- [`@vitejs/plugin-react`](https://github.com/vitejs/vite-plugin-react) v4.0.0 ç”¨äº React æ”¯æŒ
- å…¶ä»–é‡è¦ä¾èµ–:
    - `less` v4.1.3 ç”¨äºå¤„ç† Less æ ·å¼æ–‡ä»¶
    - `postcss-preset-env` v7.5.0 ç”¨äº PostCSS å¤„ç†
    - `systemjs` ç”¨äºæ¨¡å—åŠ è½½
    - `core-js` v3.34.0 ç”¨äº polyfill
1. **é¡¹ç›®ç»“æ„**
- src - æºä»£ç ç›®å½•
- bin - å¯æ‰§è¡Œæ–‡ä»¶ç›®å½•
- compiled - ç¼–è¯‘åçš„ä¾èµ–æ–‡ä»¶
- dist - æ„å»ºè¾“å‡ºç›®å½•
1. **å¼€å‘è„šæœ¬**

```
# æ„å»ºé¡¹ç›®
npm run build

# æ„å»ºä¾èµ–
npm run build:deps

# å¼€å‘æ¨¡å¼
npm run dev

# è¿è¡Œæµ‹è¯•
npm run test

```

1. **ä½œè€…**
- chencheng (sorrycc) - [https://github.com/sorrycc](https://github.com/sorrycc)

è¿™æ˜¯ UmiJS ç”Ÿæ€ä¸­çš„ä¸€ä¸ªé‡è¦ç»„ä»¶,ä¸º Umi æä¾›äº†åŸºäº Vite çš„ç°ä»£æ„å»ºèƒ½åŠ›ã€‚

## äºŒã€ä¸»è¦æ¨¡å—

ä» cli.ts å¼€å§‹åˆ†æè¿™ä¸ªé¡¹ç›®çš„ä¸»è¦æ¨¡å—:

### 1. CLI å…¥å£é€»è¾‘ (cli.ts)

```tsx
// ä¸»è¦èŒè´£:
1. è§£æå‘½ä»¤è¡Œå‚æ•°
2. å¯»æ‰¾å…¥å£æ–‡ä»¶
3. åŠ è½½é…ç½®æ–‡ä»¶
4. æ‰§è¡Œå¯¹åº”çš„å‘½ä»¤(build/dev)
```

ä¸»è¦æµç¨‹:

1. **å‚æ•°è§£æ**:
    - ä½¿ç”¨ `yParser` è§£æå‘½ä»¤è¡Œå‚æ•°
    - æ”¯æŒ `build` å’Œ `dev` ä¸¤ä¸ªä¸»å‘½ä»¤
2. **å…¥å£æ–‡ä»¶æŸ¥æ‰¾**:
    
    ```tsx
    const entry = tryPaths([
      'src/index.tsx',
      'src/index.ts',
      'index.tsx',
      'index.ts'
    ]);
    
    ```
    
3. **é…ç½®åŠ è½½**:
    - é»˜è®¤åŠ è½½ `config.ts`
    - æ”¯æŒé€šè¿‡ `-config` æŒ‡å®šé…ç½®æ–‡ä»¶
    - ä½¿ç”¨ esbuild è¿›è¡Œé…ç½®æ–‡ä»¶è§£æ
4. **å‘½ä»¤æ‰§è¡Œ**:
    - build å‘½ä»¤: ç”Ÿäº§ç¯å¢ƒæ„å»º
    - dev å‘½ä»¤: å¼€å‘ç¯å¢ƒæœåŠ¡

### 2. æœåŠ¡ç«¯æ¨¡å— (src/server/server.ts)

```tsx
// ä¸»è¦èŒè´£:
1. åˆ›å»ºå¼€å‘æœåŠ¡å™¨
2. å¤„ç†ä¸­é—´ä»¶
3. æ”¯æŒ HMR
```

### 3. ç±»å‹å®šä¹‰ (src/types.ts)

å®šä¹‰äº†ä¸»è¦çš„é…ç½®æ¥å£:

```tsx
export interface IConfig {
  alias?: Record<string, string>;
  analyze?: PluginVisualizerOptions;
  define?: { [key: string]: any };
  extraVitePlugins?: Plugin[];
  // ...å…¶ä»–é…ç½®é¡¹
}
```

## ä¸‰ã€å‚æ•°ç±»å‹

### baseType

```tsx
export interface IConfig {
  // é…ç½® webpack åˆ«åï¼Œå¯¹è±¡çš„ key æ˜¯åˆ«åï¼Œvalue æ˜¯å®é™…è·¯å¾„
  alias?: Record<string, string>;
  
  // æ„å»ºåˆ†æé…ç½®ï¼Œä½¿ç”¨ rollup-plugin-visualizer ç”Ÿæˆæ„å»ºåˆ†ææŠ¥å‘Š
  analyze?: PluginVisualizerOptions;
  
  // æ˜¯å¦è‡ªåŠ¨å¼€å¯ CSS Modules
  // å¦‚æœæ–‡ä»¶åæ»¡è¶³ *.module.* è§„åˆ™ï¼Œä¼šè‡ªåŠ¨å¼€å¯ CSS Modules
  autoCSSModules?: boolean;
  
  // é…ç½® autoprefixer å‚æ•°ï¼Œç”¨äºè‡ªåŠ¨æ·»åŠ æµè§ˆå™¨å‰ç¼€
  autoprefixer?: any;
  
  // é…ç½®è¦å¤åˆ¶çš„æ–‡ä»¶/æ–‡ä»¶å¤¹ã€‚å¯ä»¥æ˜¯å­—ç¬¦ä¸²æ•°ç»„æˆ–è€…å¸¦ from/to çš„å¯¹è±¡æ•°ç»„
  copy?: ICopy[] | string[];
  
  // ç”¨äºæ³¨å…¥å…¨å±€å˜é‡ï¼Œå¦‚ process.env
  define?: { [key: string]: any };
  
  // é…ç½®é‚£äº›æ¨¡å—ä¸æ‰“åŒ…ï¼Œè½¬è€Œé€šè¿‡ <script> æˆ–å…¶ä»–æ–¹å¼å¼•å…¥
  externals?: Record<string, string>;
  
  // é…ç½®é¢å¤–çš„ babel æ’ä»¶
  extraBabelPlugins?: IBabelPlugin[];
  
  // é…ç½®é¢å¤–çš„ babel preset
  extraBabelPresets?: IBabelPlugin[];
  
  // é…ç½®é¢å¤–çš„ PostCSS æ’ä»¶
  extraPostCSSPlugins?: any[];
  
  // é…ç½®é¢å¤–çš„ Vite æ’ä»¶
  extraVitePlugins?: Plugin[];
  
  // æ˜¯å¦å¼€å¯ hash æ¨¡å¼ï¼Œå¼€å¯åä¼šåœ¨æ–‡ä»¶åä¸­å¸¦ä¸Š hash å€¼
  hash?: boolean;
  
  // é…ç½®å›¾ç‰‡æ–‡ä»¶æ˜¯å¦è½¬ä¸º base64ï¼Œå•ä½ä¸ºå­—èŠ‚
  inlineLimit?: number;
  
  // æ˜¯å¦ç”Ÿæˆèµ„æºæ¸…å•æ–‡ä»¶ manifest.json
  manifest?: boolean;
  
  // JavaScript ä»£ç å‹ç¼©æ–¹å¼ï¼Œå¯é€‰ terserã€esbuild æˆ– none
  jsMinifier?: JSMinifier | boolean;
  
  // å‹ç¼©å™¨çš„é…ç½®é¡¹
  jsMinifierOptions?: { [key: string]: any };
  
  // Less é…ç½®é¡¹
  lessLoader?: { lessOptions: any };
  
  // æµè§ˆå™¨å…¼å®¹æ€§é…ç½®ï¼Œç”¨äºç”Ÿæˆ legacy åŒ…
  legacy?: { [key: string]: any } | boolean;
  
  // æŒ‡å®šè¾“å‡ºè·¯å¾„
  outputPath?: string;
  
  // polyfill é…ç½®ï¼Œé…ç½®éœ€è¦å¼•å…¥çš„ polyfill
  polyfill?: { imports: string[] };
  
  // PostCSS é…ç½®
  postcssLoader?: { postcssOptions: any };
  
  // å¼€å‘æœåŠ¡å™¨ä»£ç†é…ç½®
  proxy?: { [key: string]: ProxyOptions };
  
  // é…ç½® webpack çš„ publicPathï¼ŒæŒ‡å‘é™æ€èµ„æºçš„ä½ç½®
  publicPath?: string;
  
  // SVGR é…ç½®é¡¹ï¼Œç”¨äºå°† SVG è½¬ä¸º React ç»„ä»¶
  svgr?: { [key: string]: any };
  
  // SVGO é…ç½®é¡¹ï¼Œç”¨äºä¼˜åŒ– SVG æ–‡ä»¶ï¼Œè®¾ä¸º false å¯ä»¥ç¦ç”¨
  svgo?: { [key: string]: any } | false;
  
  // é…ç½®éœ€è¦å…¼å®¹çš„æµè§ˆå™¨æœ€ä½ç‰ˆæœ¬
  targets?: { [key: string]: any };
  
  // å¼€å‘æœåŠ¡å™¨ HTTPS é…ç½®
  https?: HttpsServerOptions;
  
  // å…è®¸å…¶ä»–è‡ªå®šä¹‰é…ç½®
  [key: string]: any;
}
```

è¿™äº›é…ç½®æä¾›äº†:

1. **æ„å»ºä¼˜åŒ–**ï¼šå¦‚ä»£ç å‹ç¼©ã€å“ˆå¸Œå‘½å
2. **å¼€å‘ä½“éªŒ**ï¼šå¦‚ HMRã€ä»£ç†
3. **å·¥ç¨‹åŒ–èƒ½åŠ›**ï¼šå¦‚ CSS Modulesã€Babel é…ç½®
4. **å…¼å®¹æ€§å¤„ç†**ï¼šå¦‚ polyfillã€æµè§ˆå™¨é€‚é…
5. **èµ„æºå¤„ç†**ï¼šå¦‚å›¾ç‰‡å†…è”ã€SVG å¤„ç†

å¤§éƒ¨åˆ†é…ç½®éƒ½æ˜¯å¯é€‰çš„ï¼Œä½ å¯ä»¥æ ¹æ®é¡¹ç›®éœ€æ±‚é€‰æ‹©æ€§é…ç½®ã€‚

### devType

```tsx
interface IOpts {
  // Babel æ’ä»¶é…ç½®ï¼Œä¼šåœ¨å…¶ä»– Babel æ’ä»¶ä¹‹å‰æ‰§è¡Œ
  beforeBabelPlugins?: any[];

  // Babel preset é…ç½®ï¼Œä¼šåœ¨å…¶ä»– preset ä¹‹å‰æ‰§è¡Œ
  beforeBabelPresets?: any[];

  // åœ¨é»˜è®¤ä¸­é—´ä»¶ä¹‹åæ·»åŠ çš„é¢å¤–ä¸­é—´ä»¶
  afterMiddlewares?: any[];

  // åœ¨é»˜è®¤ä¸­é—´ä»¶ä¹‹å‰æ·»åŠ çš„é¢å¤–ä¸­é—´ä»¶
  beforeMiddlewares?: any[];

  // å¼€å‘ç¯å¢ƒç¼–è¯‘å®Œæˆæ—¶çš„å›è°ƒå‡½æ•°
  onDevCompileDone?: any;

  // å¼€å‘æœåŠ¡å™¨ç«¯å£å·
  port?: number;

  // å¼€å‘æœåŠ¡å™¨ä¸»æœºå
  host?: string;

  // é¡¹ç›®æ ¹ç›®å½•è·¯å¾„
  cwd: string;

  // Vite æ„å»ºé…ç½®ï¼Œæ¥è‡ª types.ts ä¸­çš„ IConfig æ¥å£
  config: IConfig;

  // å…¥å£æ–‡ä»¶é…ç½®ï¼Œkey ä¸ºå…¥å£åï¼Œvalue ä¸ºå…¥å£æ–‡ä»¶è·¯å¾„
  entry: Record<string, string>;

  // é¢å¤–çš„ Babel æ’ä»¶é…ç½®
  extraBabelPlugins?: IBabelPlugin[];

  // é¢å¤–çš„ Babel preset é…ç½®
  extraBabelPresets?: IBabelPlugin[];

  // ç”¨äºä¿®æ”¹æœ€ç»ˆçš„ Vite é…ç½®
  modifyViteConfig?: Function;

  // åœ¨æ·»åŠ ä¸­é—´ä»¶ä¹‹å‰çš„å›è°ƒå‡½æ•°
  onBeforeMiddleware?: Function;
}

```

è¯¥é…ç½®ä¸»è¦åˆ†ä¸ºå‡ ä¸ªæ–¹é¢ï¼š

1. **Babel ç›¸å…³é…ç½®**
    - `beforeBabelPlugins` / `beforeBabelPresets`: å‰ç½®é…ç½®
    - `extraBabelPlugins` / `extraBabelPresets`: é¢å¤–é…ç½®
2. **ä¸­é—´ä»¶é…ç½®**
    - `beforeMiddlewares`: å‰ç½®ä¸­é—´ä»¶
    - `afterMiddlewares`: åç½®ä¸­é—´ä»¶
    - `onBeforeMiddleware`: ä¸­é—´ä»¶å‰ç½®é’©å­
3. **æœåŠ¡å™¨é…ç½®**
    - `port`: ç«¯å£å·
    - `host`: ä¸»æœºå
    - `cwd`: å·¥ä½œç›®å½•
4. **æ„å»ºé…ç½®**
    - `config`: Vite é…ç½®
    - `entry`: å…¥å£é…ç½®
    - `modifyViteConfig`: é…ç½®ä¿®æ”¹å‡½æ•°
5. **ç”Ÿå‘½å‘¨æœŸé’©å­**
    - `onDevCompileDone`: ç¼–è¯‘å®Œæˆé’©å­

è¿™äº›é…ç½®æä¾›äº†é«˜åº¦çš„å¯å®šåˆ¶æ€§ï¼Œå…è®¸ç”¨æˆ·ï¼š

- è‡ªå®šä¹‰æ„å»ºæµç¨‹
- æ³¨å…¥ä¸­é—´ä»¶
- ä¿®æ”¹ Babel é…ç½®
- æ§åˆ¶æœåŠ¡å™¨è¡Œä¸º
- ç›‘å¬æ„å»ºäº‹ä»¶

- å¦‚ä½•ä¿®æ”¹Babelé…ç½®å‘¢ï¼Ÿ
    
    **ä¸€ã€ é€šè¿‡é…ç½®æ–‡ä»¶ä¿®æ”¹**
    
    åœ¨é¡¹ç›®æ ¹ç›®å½•çš„ `config.ts` ä¸­é…ç½®ï¼š
    
    ```tsx
    import { defineConfig } from '@umijs/bundler-vite';
    
    export default defineConfig({
      // æ·»åŠ é¢å¤–çš„ Babel æ’ä»¶
      extraBabelPlugins: [
        // æ·»åŠ è£…é¥°å™¨æ”¯æŒ
        ['@babel/plugin-proposal-decorators', { legacy: true }],
        // æ·»åŠ ç±»å±æ€§æ”¯æŒ
        ['@babel/plugin-proposal-class-properties', { loose: true }],
      ],
    
      // æ·»åŠ é¢å¤–çš„ Babel presets
      extraBabelPresets: [
        ['@babel/preset-env', {
          targets: { browsers: ['> 1%', 'last 2 versions'] }
        }]
      ]
    });
    
    ```
    
    **äºŒã€ é€šè¿‡ API æ–¹å¼ä¿®æ”¹**
    
    åœ¨è°ƒç”¨ `dev()` æˆ– `build()` æ—¶ä¼ å…¥é…ç½®ï¼š
    
    ```tsx
    import { dev } from '@umijs/bundler-vite';
    
    await dev({
      // åœ¨å…¶ä»– Babel æ’ä»¶ä¹‹å‰æ‰§è¡Œçš„æ’ä»¶
      beforeBabelPlugins: [
        ['@babel/plugin-transform-runtime', {
          corejs: 3,
        }],
      ],
    
      // åœ¨å…¶ä»– Babel æ’ä»¶ä¹‹åæ‰§è¡Œçš„æ’ä»¶
      extraBabelPlugins: [
        'babel-plugin-import',
      ],
    
      // preset é…ç½®åŒç†
      beforeBabelPresets: [],
      extraBabelPresets: [],
    });
    
    ```
    
    **ä¸‰ã€ å¸¸ç”¨ Babel é…ç½®ç¤ºä¾‹**
    
    1. æŒ‰éœ€åŠ è½½ç¤ºä¾‹
        
        ```tsx
        export default defineConfig({
          extraBabelPlugins: [
            // antd æŒ‰éœ€åŠ è½½
            ['babel-plugin-import', {
              libraryName: 'antd',
              libraryDirectory: 'es',
              style: true
            }],
          ]
        });
        
        ```
        
    2. è£…é¥°å™¨æ”¯æŒç¤ºä¾‹
        
        ```tsx
        export default defineConfig({
          extraBabelPlugins: [
            ['@babel/plugin-proposal-decorators', { legacy: true }],
            ['@babel/plugin-proposal-class-properties', { loose: true }]
          ]
        });
        
        ```
        
    3. ç¯å¢ƒé€‚é…ç¤ºä¾‹
        
        ```tsx
        export default defineConfig({
          extraBabelPresets: [
            ['@babel/preset-env', {
              targets: {
                chrome: '49',
                firefox: '64',
                safari: '10',
                edge: '13',
                ios: '10'
              },
              useBuiltIns: 'usage',
              corejs: 3
            }]
          ]
        });
        
        ```
        
    
    **æ³¨æ„äº‹é¡¹**
    
    1. `beforeBabelPlugins` ä¼šåœ¨é»˜è®¤æ’ä»¶ä¹‹å‰æ‰§è¡Œ
    2. `extraBabelPlugins` ä¼šåœ¨é»˜è®¤æ’ä»¶ä¹‹åæ‰§è¡Œ
    3. æ’ä»¶é¡ºåºå¾ˆé‡è¦ï¼Œå¯èƒ½ä¼šå½±å“ç¼–è¯‘ç»“æœ
    4. å»ºè®®ä¼˜å…ˆä½¿ç”¨é…ç½®æ–‡ä»¶æ–¹å¼è¿›è¡Œé…ç½®
    5. éœ€è¦å®‰è£…ç›¸å…³çš„ Babel æ’ä»¶ä¾èµ–

### buildType

```tsx
interface IOpts {
  // é¡¹ç›®æ ¹ç›®å½•è·¯å¾„
  cwd: string;

  // æ„å»ºå…¥å£é…ç½®
  // key: å…¥å£åç§°
  // value: å…¥å£æ–‡ä»¶è·¯å¾„
  entry: Record<string, string>;

  // Vite æ„å»ºé…ç½®ï¼Œç»§æ‰¿è‡ª IConfig æ¥å£
  config: IConfig;

  // æ„å»ºå®Œæˆæ—¶çš„å›è°ƒå‡½æ•°
  // å‚æ•°ä¸º IBuildResultï¼ŒåŒ…å«æ„å»ºç»“æœä¿¡æ¯
  onBuildComplete?: Function;

  // æ˜¯å¦åœ¨æ„å»ºå‰æ¸…ç©ºè¾“å‡ºç›®å½•
  clean?: boolean;

  // åœ¨é»˜è®¤ Babel æ’ä»¶ä¹‹å‰æ‰§è¡Œçš„æ’ä»¶æ•°ç»„
  beforeBabelPlugins?: any[];

  // åœ¨é»˜è®¤ Babel preset ä¹‹å‰æ‰§è¡Œçš„ preset æ•°ç»„
  beforeBabelPresets?: any[];

  // é¢å¤–çš„ Babel æ’ä»¶é…ç½®
  extraBabelPlugins?: IBabelPlugin[];

  // é¢å¤–çš„ Babel preset é…ç½®
  extraBabelPresets?: IBabelPlugin[];

  // ç”¨äºä¿®æ”¹æœ€ç»ˆçš„ Vite é…ç½®çš„å‡½æ•°
  modifyViteConfig?: Function;
}

```

### ä½¿ç”¨ç¤ºä¾‹

```tsx
import { defineConfig } from '@umijs/bundler-vite';

export default defineConfig({
  // é…ç½®å…¥å£æ–‡ä»¶
  entry: {
    main: './src/index.tsx',
    admin: './src/admin.tsx'
  },

  // æ„å»ºè¾“å‡ºç›®å½•
  outputPath: 'dist',

  // å…¬å…±è·¯å¾„å‰ç¼€
  publicPath: '/',

  // æ˜¯å¦å¼€å¯æ–‡ä»¶ hash
  hash: true,

  // å®šä¹‰å…¨å±€å˜é‡
  define: {
    'process.env.APP_ENV': JSON.stringify('production'),
  },

  // é…ç½® alias åˆ«å
  alias: {
    '@': './src',
    '@components': './src/components',
  },
});

```

è¿›é˜¶é…ç½®ç¤ºä¾‹

```tsx
import { defineConfig } from '@umijs/bundler-vite';

export default defineConfig({
  // åŸºç¡€é…ç½®
  entry: './src/index.tsx',
  outputPath: 'dist',

  // æ„å»ºä¼˜åŒ–ç›¸å…³
  jsMinifier: 'terser',
  jsMinifierOptions: {
    compress: {
      drop_console: true,
    },
  },

  // CSS ç›¸å…³é…ç½®
  autoCSSModules: true,
  lessLoader: {
    lessOptions: {
      javascriptEnabled: true,
    },
  },

  // æµè§ˆå™¨å…¼å®¹æ€§
  targets: {
    chrome: 49,
    firefox: 64,
    safari: 10,
    edge: 13,
    ios: 10,
  },

  // æ„å»ºåˆ†æ
  analyze: {
    open: true,
  },

  // å¼€å‘æœåŠ¡å™¨é…ç½®
  proxy: {
    '/api': {
      target: '<http://localhost:3000>',
      changeOrigin: true,
    },
  },
});

```

### ç¯å¢ƒå˜é‡é…ç½®

```tsx
import { defineConfig } from '@umijs/bundler-vite';

export default defineConfig({
  define: {
    'process.env.NODE_ENV': JSON.stringify('development'),
    'process.env.API_URL': JSON.stringify('<http://dev-api.example.com>'),
  },
});

```

```tsx
import { defineConfig } from '@umijs/bundler-vite';

export default defineConfig({
  define: {
    'process.env.NODE_ENV': JSON.stringify('production'),
    'process.env.API_URL': JSON.stringify('<https://api.example.com>'),
  },
});

```

### ä½¿ç”¨æ–¹æ³•

1. åˆ›å»ºé…ç½®æ–‡ä»¶åï¼Œå¯ä»¥é€šè¿‡å‘½ä»¤è¡Œå·¥å…·ä½¿ç”¨ï¼š

```bash
# å¼€å‘ç¯å¢ƒ
$ umi dev

# ç”Ÿäº§ç¯å¢ƒæ„å»º
$ umi build

```

1. æˆ–è€…åœ¨ package.json ä¸­é…ç½®è„šæœ¬ï¼š

```json
{
  "scripts": {
    "dev": "umi dev",
    "build": "umi build",
    "build:prod": "cross-env UMI_ENV=prod umi build"
  }
}

```

### æ³¨æ„äº‹é¡¹

1. é…ç½®æ–‡ä»¶æ”¯æŒ TypeScriptï¼Œæ¨èä½¿ç”¨ `defineConfig` è·å¾—ç±»å‹æç¤º
2. å¯ä»¥æ ¹æ®ä¸åŒç¯å¢ƒåˆ›å»ºä¸åŒçš„é…ç½®æ–‡ä»¶ï¼š
    - `config.ts` - åŸºç¡€é…ç½®
    - `config.dev.ts` - å¼€å‘ç¯å¢ƒé…ç½®
    - `config.prod.ts` - ç”Ÿäº§ç¯å¢ƒé…ç½®
3. é…ç½®æ–‡ä»¶çš„ä¿®æ”¹ä¼šè‡ªåŠ¨è§¦å‘é‡æ–°æ„å»º
4. æ‰€æœ‰è·¯å¾„éƒ½ç›¸å¯¹äºé¡¹ç›®æ ¹ç›®å½•

### é…ç½®ç‰¹ç‚¹

1. **è·¯å¾„é…ç½®**
    - `cwd`: ç¡®ä¿æ‰€æœ‰ç›¸å¯¹è·¯å¾„éƒ½åŸºäºé¡¹ç›®æ ¹ç›®å½•
2. **å…¥å£ç®¡ç†**
    - `entry`: æ”¯æŒå¤šå…¥å£æ„å»º
    - æ¯ä¸ªå…¥å£å¯ä»¥ç‹¬ç«‹é…ç½®è·¯å¾„
3. **æ„å»ºä¼˜åŒ–**
    - `beforeBabelPlugins/beforeBabelPresets`: å‰ç½®å¤„ç†
    - `extraBabelPlugins/extraBabelPresets`: åç½®å¤„ç†
4. **ç”Ÿå‘½å‘¨æœŸ**
    - `onBuildComplete`: æ„å»ºå®Œæˆåçš„å¤„ç†
    - `clean`: æ„å»ºå‰çš„æ¸…ç†å·¥ä½œ
5. **æ‰©å±•æ€§**
    - `modifyViteConfig`: å…è®¸æ·±åº¦å®šåˆ¶ Vite é…ç½®

è¿™äº›é…ç½®é¡¹æä¾›äº†çµæ´»çš„æ„å»ºå®šåˆ¶èƒ½åŠ›ï¼Œå¯ä»¥æ ¹æ®é¡¹ç›®éœ€æ±‚è¿›è¡Œç›¸åº”è°ƒæ•´ã€‚

è¿è¡Œæ˜¯ç±»å‹æ ¡éªŒ

- **hapijs/[joi](https://github.com/hapijs/joi)**
    
    `src/schema.ts`
    
    **Schema** éªŒè¯ä¸»è¦åœ¨ä»¥ä¸‹å‡ ä¸ªæ—¶æœºä½¿ç”¨:
    
    1. é…ç½®åŠ è½½æ—¶
        
        å½“ç”¨æˆ·çš„é…ç½®æ–‡ä»¶è¢«åŠ è½½æ—¶ï¼Œä¼šè¿›è¡ŒéªŒè¯ï¼š
        
        ```tsx
        import { getSchemas } from '../schema';
        import Joi from '@hapi/joi';
        
        export async function getUserConfig(opts: {
          cwd: string;
          config: Record<string, any>;
        }) {
          // è·å– schema å®šä¹‰
          const schemas = getSchemas();
        
          // åˆ›å»ºéªŒè¯å¯¹è±¡
          const schema = Joi.object(schemas);
        
          // éªŒè¯ç”¨æˆ·é…ç½®
          const { error, value } = schema.validate(opts.config, {
            allowUnknown: true,
            abortEarly: false,
          });
        
          // å¦‚æœæœ‰é”™è¯¯ï¼ŒæŠ›å‡ºè¯¦ç»†ä¿¡æ¯
          if (error) {
            throw new Error(`é…ç½®éªŒè¯å¤±è´¥:\\n${error.message}`);
          }
        
          return value;
        }
        
        ```
        
    2. å‘½ä»¤æ‰§è¡Œå‰
        
        åœ¨æ‰§è¡Œ `dev` æˆ– `build` å‘½ä»¤å‰ä¼šè¿›è¡ŒéªŒè¯ï¼š
        
        ```tsx
        import { validateConfig } from './config/validate';
        
        async function run() {
          // ...existing code...
        
          // éªŒè¯é…ç½®
          try {
            await validateConfig(config);
          } catch (err) {
            console.error(chalk.red('é…ç½®é”™è¯¯:'), err.message);
            process.exit(1);
          }
        
          if (command === 'dev') {
            // ...existing code...
          }
        }
        
        ```
        
    

## å››ã€`dev`è¿è¡Œæ—¶åˆ†æ

### 1. è°ƒç”¨å…¥å£

å¼€å‘æœåŠ¡ä» `dev()` å‡½æ•°å¼€å§‹ï¼Œæ¥æ”¶ `IOpts` é…ç½®å‚æ•°ã€‚

### 2. é…ç½®å¤„ç†é˜¶æ®µ

2.1 è·å– Vite é…ç½®

é€šè¿‡ `getConfig()` å¤„ç†é…ç½®:

```tsx
const viteConfig = await getConfig({
  // é¡¹ç›®æ ¹ç›®å½•
  cwd: opts.cwd,

  // ç¯å¢ƒè®¾ç½®ä¸ºå¼€å‘ç¯å¢ƒ
  env: Env.development,

  // é¡¹ç›®å…¥å£æ–‡ä»¶
  entry: opts.entry,

  // ç”¨æˆ·é…ç½®
  userConfig: opts.config,

  // åˆå¹¶ Babel æ’ä»¶é…ç½®
  extraBabelPlugins: [
    ...(opts.beforeBabelPlugins || []),
    ...(opts.extraBabelPlugins || []),
  ],

  // åˆå¹¶ Babel presets é…ç½®
  extraBabelPresets: [
    ...(opts.beforeBabelPresets || []),
    ...(opts.extraBabelPresets || []),
  ],

  // Vite é…ç½®ä¿®æ”¹å‡½æ•°
  modifyViteConfig: opts.modifyViteConfig,
});

```

### 3. æœåŠ¡å™¨åˆ›å»ºé˜¶æ®µ

3.1 åˆ›å»ºå¼€å‘æœåŠ¡å™¨

é€šè¿‡ `createServer()` å¯åŠ¨æœåŠ¡:

```tsx
await createServer({
  // Vite é…ç½®
  viteConfig,

  // ç”¨æˆ·é…ç½®
  userConfig: opts.config,

  // é¡¹ç›®æ ¹ç›®å½•
  cwd: opts.cwd,

  // æœåŠ¡å™¨ç«¯å£
  port: opts.port,

  // æœåŠ¡å™¨ä¸»æœºå
  host: opts.host,

  // ä¸­é—´ä»¶é…ç½®
  beforeMiddlewares: opts.beforeMiddlewares,
  afterMiddlewares: opts.afterMiddlewares,

  // ç”Ÿå‘½å‘¨æœŸé’©å­
  onDevCompileDone: opts.onDevCompileDone,
  onBeforeMiddleware: opts.onBeforeMiddleware,
});

```

### 4. æ‰§è¡Œæµç¨‹

1. **åˆå§‹åŒ–é˜¶æ®µ**
    - è§£æå‘½ä»¤è¡Œå‚æ•°
    - åŠ è½½ç”¨æˆ·é…ç½®æ–‡ä»¶
    - æ ¡éªŒé…ç½®åˆæ³•æ€§
2. **é…ç½®å¤„ç†é˜¶æ®µ**
    - åˆå¹¶é»˜è®¤é…ç½®å’Œç”¨æˆ·é…ç½®
    - å¤„ç† Babel é…ç½®
    - å¤„ç† Vite é…ç½®
    - åº”ç”¨é…ç½®ä¿®æ”¹å‡½æ•°
3. **æœåŠ¡å™¨å¯åŠ¨é˜¶æ®µ**
    - åˆ›å»º Vite å¼€å‘æœåŠ¡å™¨
    - é…ç½®ä¸­é—´ä»¶é“¾
    - è®¾ç½®ç«¯å£å’Œä¸»æœº
    - æ³¨å†Œç”Ÿå‘½å‘¨æœŸé’©å­
4. **ç¼–è¯‘å’Œç›‘å¬é˜¶æ®µ**
    - æ‰§è¡Œé¦–æ¬¡ç¼–è¯‘
    - å¯åŠ¨æ–‡ä»¶ç›‘å¬
    - å¼€å¯çƒ­æ›´æ–°æœåŠ¡
    - è§¦å‘ç¼–è¯‘å®Œæˆå›è°ƒ

### 5. å…³é”®äº‹ä»¶ç‚¹

1. **é…ç½®åŠ è½½æ—¶**
    - è¯»å– `config.ts`
    - æ ¡éªŒé…ç½®æ ¼å¼
    - åˆå¹¶é»˜è®¤å€¼
2. **æœåŠ¡å¯åŠ¨å‰**
    - æ‰§è¡Œ `beforeMiddlewares`
    - é…ç½®ä»£ç†è§„åˆ™
    - è®¾ç½®é™æ€èµ„æº
3. **ç¼–è¯‘è¿‡ç¨‹ä¸­**
    - æ‰§è¡Œ Babel è½¬æ¢
    - å¤„ç† CSS/Less
    - å¤„ç†å›¾ç‰‡ç­‰èµ„æº
4. **ç¼–è¯‘å®Œæˆå**
    - è§¦å‘ `onDevCompileDone`
    - å¯åŠ¨æ–‡ä»¶ç›‘å¬
    - å‡†å¤‡æ¥æ”¶è¯·æ±‚

æ•´ä¸ªè¿‡ç¨‹æ˜¯ä¸€ä¸ªå®Œæ•´çš„å¼€å‘æœåŠ¡å™¨å¯åŠ¨æµç¨‹ï¼ŒåŒ…å«é…ç½®å¤„ç†ã€æœåŠ¡åˆ›å»ºã€ä¸­é—´ä»¶æ³¨å†Œç­‰å…³é”®æ­¥éª¤ã€‚

## äº”ã€`createServer`è¿è¡Œæ—¶åˆ†æ

**ä¸ Vite é»˜è®¤ Server çš„å¯¹æ¯”åˆ†æ**

### ä¸»è¦åŒºåˆ«

1. ä¸­é—´ä»¶æ‰©å±•æœºåˆ¶
    
    Umi çš„ server å¢åŠ äº†æ›´çµæ´»çš„ä¸­é—´ä»¶æ§åˆ¶ï¼š
    
    ```tsx
    // 1. å‰ç½®ä¸­é—´ä»¶
    opts.beforeMiddlewares?.forEach((m) => app.use(m));
    
    // 2. è‡ªå®šä¹‰ä¸­é—´ä»¶æ³¨å…¥ç‚¹
    if (opts.onBeforeMiddleware) {
      opts.onBeforeMiddleware(app);
    }
    
    // 3. åç½®ä¸­é—´ä»¶ï¼ˆåœ¨ SPA fallback ä¹‹å‰ï¼‰
    if (opts.afterMiddlewares?.length) {
      // ç‰¹æ®Šå¤„ç†ä¸­é—´ä»¶æ’å…¥ä½ç½®
      vite.middlewares.stack.some((s, i) => {
        if ((s.handle as Function).name === 'viteSpaFallbackMiddleware') {
          // ...æ’å…¥åç½®ä¸­é—´ä»¶
        }
        return false;
      });
    }
    
    ```
    
2. ç¼–è¯‘çŠ¶æ€ç›‘æ§
    
    å¢åŠ äº†æ›´å®Œå–„çš„ç¼–è¯‘çŠ¶æ€è¿½è¸ªï¼š
    
    ```tsx
    // Vite æ’ä»¶æ‰©å±•ï¼Œç”¨äºç›‘æ§çƒ­æ›´æ–°
    plugins: viteConfig.plugins!.concat([
      pluginOnHotUpdate(async (modules) => {
        await onDevCompileDone({
          time: 0,
          isFirstCompile: false,
          stats: modules,
        });
      }),
    ]),
    
    ```
    
3. HTTPS æ”¯æŒå¢å¼º
    
    æ›´çµæ´»çš„ HTTPS é…ç½®å¤„ç†ï¼š
    
    ```tsx
    // HTTPS é…ç½®å¤„ç†
    if (userConfig.https) {
      const httpsConfig = await resolveHttpsConfig(userConfig.https);
      if (httpsConfig) {
        userConfig.https = viteConfigServer.https = {
          key: httpsConfig.key,
          cert: httpsConfig.cert,
        };
      }
    }
    
    ```
    
4. ä»£ç†é…ç½®é›†æˆ
    
    å†…ç½®äº†ä»£ç†åŠŸèƒ½çš„é›†æˆï¼š
    
    ```tsx
    // ä»£ç†é…ç½®
    if (userConfig.proxy) {
      createProxy(userConfig.proxy, app);
    }
    
    ```
    
5. å¯åŠ¨ä¿¡æ¯ä¼˜åŒ–
    
    æä¾›äº†æ›´å‹å¥½çš„å¼€å‘æœåŠ¡å™¨å¯åŠ¨ä¿¡æ¯ï¼š
    
    ```tsx
    const banner = getDevBanner(protocol, opts.host, port);
    console.log(banner.before);
    logger.ready(banner.main);
    console.log(banner.after);
    
    ```
    

### åŠŸèƒ½å¢å¼ºç‚¹

1. **ä¸­é—´ä»¶ç®¡ç†**
    - æ›´ç»†ç²’åº¦çš„ä¸­é—´ä»¶æ§åˆ¶
    - æ”¯æŒå‰ç½®å’Œåç½®ä¸­é—´ä»¶
    - å¯è‡ªå®šä¹‰ä¸­é—´ä»¶æ³¨å…¥æ—¶æœº
2. **å¼€å‘ä½“éªŒ**
    - æ›´å®Œå–„çš„ç¼–è¯‘çŠ¶æ€åé¦ˆ
    - æ›´å‹å¥½çš„å¯åŠ¨ä¿¡æ¯å±•ç¤º
    - æ›´å¼ºå¤§çš„ HTTPS é…ç½®æ”¯æŒ
3. **é›†æˆèƒ½åŠ›**
    - å†…ç½®ä»£ç†åŠŸèƒ½
    - æ”¯æŒæ›´å¤šè‡ªå®šä¹‰é…ç½®
    - æä¾›æ›´å¤šç”Ÿå‘½å‘¨æœŸé’©å­
4. **æ‰©å±•æ€§**
    - å¯ä»¥é€šè¿‡ä¸­é—´ä»¶æ‰©å±•æ›´å¤šåŠŸèƒ½
    - æ”¯æŒé€šè¿‡æ’ä»¶æ‰©å±• Vite èƒ½åŠ›
    - æä¾›æ›´å¤šé…ç½®é¡¹

### æ€»ç»“

Umi çš„ Vite Server æ˜¯å¯¹åŸç”Ÿ Vite Dev Server çš„å¢å¼ºç‰ˆæœ¬ï¼Œä¸»è¦ä½“ç°åœ¨ï¼š

1. æ›´å¼ºçš„å¯æ‰©å±•æ€§
2. æ›´å¥½çš„å¼€å‘ä½“éªŒ
3. æ›´å¤šçš„å†…ç½®åŠŸèƒ½
4. æ›´çµæ´»çš„é…ç½®é€‰é¡¹
5. æ›´å®Œå–„çš„ä¸­é—´ä»¶ç³»ç»Ÿ

è¿™äº›å¢å¼ºä½¿å¾—å®ƒæ›´é€‚åˆåœ¨ä¼ä¸šçº§é¡¹ç›®ä¸­ä½¿ç”¨ï¼Œç‰¹åˆ«æ˜¯åœ¨éœ€è¦æ›´å¤šè‡ªå®šä¹‰é…ç½®å’Œæ‰©å±•èƒ½åŠ›çš„åœºæ™¯ã€‚

## å…­ã€`build`æ„å»ºæ—¶åˆ†æ

### 1. æ„å»ºå…¥å£

æ„å»ºä» `build()` å‡½æ•°å¼€å§‹ï¼Œæ¥æ”¶ `IOpts` ç±»å‹çš„é…ç½®å‚æ•°ï¼š

```tsx
interface IOpts {
  // é¡¹ç›®æ ¹ç›®å½•
  cwd: string;
  // å…¥å£æ–‡ä»¶é…ç½®
  entry: Record<string, string>;
  // ç”¨æˆ·é…ç½®
  config: IConfig;
  // æ„å»ºå®Œæˆå›è°ƒ
  onBuildComplete?: Function;
  // æ˜¯å¦æ¸…ç†è¾“å‡ºç›®å½•
  clean?: boolean;
  // Babel ç›¸å…³é…ç½®
  beforeBabelPlugins?: any[];
  beforeBabelPresets?: any[];
  extraBabelPlugins?: IBabelPlugin[];
  extraBabelPresets?: IBabelPlugin[];
  // Vite é…ç½®ä¿®æ”¹å‡½æ•°
  modifyViteConfig?: Function;
}

```

### 2. æ„å»ºè¿‡ç¨‹

2.1 ä¸´æ—¶å…¥å£æ–‡ä»¶ç”Ÿæˆ

```tsx
const tmpHtmlEntry = generateTempEntry(opts.cwd, opts.entry);

```

- åœ¨ `.tmp` ç›®å½•ç”Ÿæˆä¸´æ—¶ HTML æ–‡ä»¶
- ä¸ºæ¯ä¸ªå…¥å£ç‚¹åˆ›å»ºå¯¹åº”çš„ HTML æ–‡ä»¶
- æ³¨å…¥ module script æ ‡ç­¾

2.2 Vite é…ç½®å¤„ç†

```tsx
const viteUserConfig = await getConfig({
  cwd: opts.cwd,
  env: Env.production,
  entry: opts.entry,
  userConfig: opts.config,
  extraBabelPlugins: [
    ...(opts.beforeBabelPlugins || []),
    ...(opts.extraBabelPlugins || []),
  ],
  extraBabelPresets: [
    ...(opts.beforeBabelPresets || []),
    ...(opts.extraBabelPresets || []),
  ],
  modifyViteConfig: opts.modifyViteConfig,
});

```

2.3 æ„å»ºé…ç½®åˆå¹¶

```tsx
const viteBuildConfig = mergeConfig(
  {
    root: opts.cwd,
    mode: Env.production,
    build: {
      rollupOptions: tmpHtmlEntry
        ? {
            input: tmpHtmlEntry,
            plugins: [
              deleteOutputFiles(Object.values(tmpHtmlEntry), (file) => {
                // æå– HTML éƒ¨åˆ†
                if (file.type === 'asset') {
                  const $ = cheerio.load(file.source);
                  extraHtmlPart = {
                    head: $('head').html(),
                    body: $('body').html(),
                  };
                }
              }),
            ],
          }
        : {},
    },
  },
  viteUserConfig,
);

```

### 3. æ„å»ºç‰¹ç‚¹

1. **HTML å¤„ç†æœºåˆ¶**
    - ç”Ÿæˆä¸´æ—¶ HTML ä½œä¸ºæ„å»ºå…¥å£
    - æå– HTML å†…å®¹ä¾›åç»­ä½¿ç”¨
    - æ„å»ºå®Œæˆåæ¸…ç†ä¸´æ—¶æ–‡ä»¶
2. **é…ç½®å¤„ç†æµç¨‹**
    - åˆå¹¶ç”¨æˆ·é…ç½®å’Œé»˜è®¤é…ç½®
    - æ”¯æŒ Babel æ’ä»¶é…ç½®
    - å…è®¸è‡ªå®šä¹‰ä¿®æ”¹ Vite é…ç½®
3. **æ„å»ºç»“æœå¤„ç†**
    - è®°å½•æ„å»ºæ—¶é—´
    - ä¿å­˜æ„å»ºç»Ÿè®¡ä¿¡æ¯
    - æ”¯æŒæ„å»ºå®Œæˆå›è°ƒ

### 4. ä¸æ™®é€š Vite æ„å»ºçš„åŒºåˆ«

1. **å…¥å£å¤„ç†**
    - Umi: è‡ªåŠ¨ç”Ÿæˆä¸´æ—¶ HTML å…¥å£
    - Vite: ç›´æ¥ä½¿ç”¨é…ç½®çš„å…¥å£æ–‡ä»¶
2. **æ„å»ºé…ç½®**
    - Umi: æ›´å¤šé¢„è®¾å’Œçº¦å®š
    - Vite: æ›´çµæ´»ä½†éœ€è¦æ‰‹åŠ¨é…ç½®
3. **HTML å¤„ç†**
    - Umi: æä¾› HTML å†…å®¹æå–
    - Vite: éœ€è¦é€šè¿‡æ’ä»¶å®ç°
4. **æ„å»ºç»“æœ**
    - Umi: æä¾›æ›´å¤šå…ƒæ•°æ®
    - Vite: åŸºç¡€æ„å»ºä¿¡æ¯

## 5. ä½¿ç”¨åœºæ™¯

- ä¼ä¸šçº§åº”ç”¨æ„å»º
- çº¦å®šå¼å¼€å‘æµç¨‹
- éœ€è¦ç»Ÿä¸€æ„å»ºè§„èŒƒ
- å¤šé¡µé¢åº”ç”¨æ„å»º
- éœ€è¦æ›´å¤šæ„å»ºä¿¡æ¯çš„åœºæ™¯

ä½¿ç”¨`mergeConfig` åˆå¹¶ç”¨æˆ·çš„`config`å’Œé¢„è®¾çš„`config`

æœ€åä½¿ç”¨`viteBuilder`æ„å»ºé¡¹ç›®

## ä¸ƒã€å¦‚ä½•æ·»åŠ ä¸€ä¸ªæ’ä»¶

åœ¨ Umi Vite ä¸­æ·»åŠ æ’ä»¶æœ‰ä¸¤ç§æ–¹å¼ï¼š

### 1. é€šè¿‡é…ç½®æ–‡ä»¶æ·»åŠ  Vite æ’ä»¶

```tsx
import { defineConfig } from '@umijs/bundler-vite';
import myVitePlugin from './myVitePlugin';

export default defineConfig({
  // æ·»åŠ é¢å¤–çš„ Vite æ’ä»¶
  extraVitePlugins: [
    myVitePlugin({
      // æ’ä»¶é…ç½®
    })
  ]
});

```

### 2. åˆ›å»ºè‡ªå®šä¹‰ Vite æ’ä»¶

```tsx
import type { Plugin } from 'vite';

export default function myVitePlugin(options = {}): Plugin {
  return {
    // æ’ä»¶åç§°
    name: 'vite-plugin-my-plugin',

    // é…ç½®é’©å­
    config(config) {
      return {
        // ä¿®æ”¹ vite é…ç½®
      };
    },

    // æ„å»ºå¼€å§‹
    buildStart() {
      // ...
    },

    // è½¬æ¢ä»£ç 
    transform(code, id) {
      // å¤„ç†ä»£ç è½¬æ¢
      return {
        code: transformedCode,
        map: sourceMap
      };
    },

    // æ„å»ºç»“æŸ
    buildEnd() {
      // ...
    },

    // ç”Ÿæˆèµ„æº
    generateBundle(options, bundle) {
      // å¤„ç†æ‰“åŒ…åçš„æ–‡ä»¶
    }
  };
}

```

### 3. æ’ä»¶å¼€å‘ç¤ºä¾‹

3.1 èµ„æºå¤„ç†æ’ä»¶

```tsx
import type { Plugin } from 'vite';
import imagemin from 'imagemin';

export default function imageOptimizerPlugin(): Plugin {
  return {
    name: 'vite-plugin-image-optimizer',

    async transform(code, id) {
      if (!id.match(/\\.(png|jpg|jpeg|gif|svg)$/)) return;

      const optimizedBuffer = await imagemin.buffer(code);

      return {
        code: optimizedBuffer,
        map: null
      };
    }
  };
}

```

3.2 å¼€å‘è°ƒè¯•æ’ä»¶

```tsx
import type { Plugin } from 'vite';

export default function devLogger(): Plugin {
  return {
    name: 'vite-plugin-dev-logger',

    configureServer(server) {
      server.middlewares.use((req, res, next) => {
        console.log(`[${new Date().toLocaleTimeString()}] ${req.url}`);
        next();
      });
    }
  };
}

```

### 4. åœ¨é¡¹ç›®ä¸­ä½¿ç”¨æ’ä»¶

```tsx
import { defineConfig } from '@umijs/bundler-vite';
import imageOptimizer from './plugins/imageOptimizer';
import devLogger from './plugins/devLogger';

export default defineConfig({
  extraVitePlugins: [
    imageOptimizer(),
    process.env.NODE_ENV === 'development' && devLogger()
  ].filter(Boolean)
});

```

### æ³¨æ„äº‹é¡¹

1. æ’ä»¶æ‰§è¡Œé¡ºåºå¾ˆé‡è¦ï¼š
    - åœ¨ `extraVitePlugins` ä¸­çš„é¡ºåºå†³å®šäº†æ’ä»¶çš„æ‰§è¡Œé¡ºåº
    - æŸäº›æ’ä»¶å¯èƒ½éœ€è¦åœ¨ç‰¹å®šæ’ä»¶ä¹‹å‰/ä¹‹åæ‰§è¡Œ
2. å¼€å‘ç¯å¢ƒä¸ç”Ÿäº§ç¯å¢ƒï¼š
    - å¯ä»¥é€šè¿‡ `process.env.NODE_ENV` åˆ¤æ–­ç¯å¢ƒ
    - æŸäº›æ’ä»¶å¯èƒ½åªéœ€è¦åœ¨ç‰¹å®šç¯å¢ƒä¸­å¯ç”¨
3. æ€§èƒ½è€ƒè™‘ï¼š
    - é¿å…åœ¨å¼€å‘ç¯å¢ƒè¿›è¡Œé‡é‡çº§æ“ä½œ
    - åˆç†ä½¿ç”¨ç¼“å­˜æœºåˆ¶
4. é”™è¯¯å¤„ç†ï¼š
    - æ’ä»¶ä¸­è¦åšå¥½é”™è¯¯å¤„ç†
    - æä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯

## å…«ã€buildæ„å»ºæ—¶æ’ä»¶

ä¸‹é¢åˆ›å»ºä¸€ä¸ªä¸Šä¼  `authMenu.json` çš„æ„å»ºæ’ä»¶

### 1. åˆ›å»ºæ’ä»¶æ–‡ä»¶

```tsx
import type { Plugin } from 'vite';
import fs from 'fs';
import path from 'path';
import axios from 'axios';

interface UploadAuthMenuOptions {
  // æ˜¯å¦å¯ç”¨ä¸Šä¼ 
  enable?: boolean;
  // ä¸Šä¼ åœ°å€
  uploadUrl?: string;
  // è®¤è¯ä¿¡æ¯
  token?: string;
  // æ–‡ä»¶è·¯å¾„
  menuPath?: string;
}

export default function uploadAuthMenuPlugin(options: UploadAuthMenuOptions = {}): Plugin {
  const {
    enable = false,
    uploadUrl = '<http://your-api.com/upload>',
    token = '',
    menuPath = 'authMenu.json'
  } = options;

  return {
    name: 'vite-plugin-upload-auth-menu',

    async closeBundle() {
      if (!enable) {
        console.log('ğŸ“ Skip uploading authMenu.json');
        return;
      }

      const menuFile = path.resolve(process.cwd(), menuPath);

      if (!fs.existsSync(menuFile)) {
        console.error('âŒ authMenu.json not found');
        return;
      }

      try {
        const menuContent = fs.readFileSync(menuFile, 'utf-8');

        await axios.post(uploadUrl, {
          menu: JSON.parse(menuContent)
        }, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        console.log('âœ… Successfully uploaded authMenu.json');
      } catch (error) {
        console.error('âŒ Failed to upload authMenu.json:', error);
      }
    }
  };
}

```

### 2. é…ç½®ä½¿ç”¨æ’ä»¶

```tsx
import { defineConfig } from '@umijs/bundler-vite';
import uploadAuthMenuPlugin from './plugins/uploadAuthMenuPlugin';

export default defineConfig({
  extraVitePlugins: [
    uploadAuthMenuPlugin({
      // é€šè¿‡ç¯å¢ƒå˜é‡æˆ–å‚æ•°æ§åˆ¶æ˜¯å¦å¯ç”¨
      enable: process.env.UPLOAD_AUTH_MENU === 'true',
      uploadUrl: process.env.AUTH_MENU_URL,
      token: process.env.AUTH_TOKEN,
      menuPath: 'src/config/authMenu.json'
    })
  ]
});

```

### 3. ä½¿ç”¨æ–¹æ³•

æ·»åŠ æ„å»ºå‘½ä»¤

```json
{
  "scripts": {
    "build": "umi build",
    "build:with-menu": "cross-env UPLOAD_AUTH_MENU=true AUTH_MENU_URL=http://api.example.com/upload AUTH_TOKEN=your-token umi build"
  }
}

```

æ‰§è¡Œæ„å»º

```bash
# æ™®é€šæ„å»º
npm run build

# å¸¦èœå•ä¸Šä¼ çš„æ„å»º
npm run build:with-menu
```

### æ³¨æ„äº‹é¡¹

1. **å®‰å…¨æ€§**
    - ä¸è¦åœ¨ä»£ç ä¸­ç¡¬ç¼–ç  token
    - å»ºè®®ä½¿ç”¨ç¯å¢ƒå˜é‡ä¼ é€’æ•æ„Ÿä¿¡æ¯
2. **é”™è¯¯å¤„ç†**
    - æ’ä»¶åŒ…å«å®Œæ•´çš„é”™è¯¯å¤„ç†
    - æä¾›æ¸…æ™°çš„æ—¥å¿—è¾“å‡º
3. **é…ç½®çµæ´»æ€§**
    - æ‰€æœ‰å‚æ•°éƒ½å¯é…ç½®
    - æ”¯æŒé€šè¿‡ç¯å¢ƒå˜é‡æ§åˆ¶
4. **ä¾èµ–ç®¡ç†**
    - éœ€è¦å®‰è£… axios ä¾èµ–ï¼š
    
    ```bash
    npm install axios --save-dev
    
    ```
    

è¿™ä¸ªæ’ä»¶ä¼šåœ¨æ„å»ºå®Œæˆåï¼Œæ ¹æ®é…ç½®å†³å®šæ˜¯å¦ä¸Šä¼  authMenu.json æ–‡ä»¶ã€‚ä½ å¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡æ¥æ§åˆ¶ä¸Šä¼ è¡Œä¸ºã€‚